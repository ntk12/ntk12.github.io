<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="theme-color" content="#680"><title>Testing http client in Go</title><meta name="description" content="Testing http client in go"><link rel="stylesheet" href="/css/prism-base16-monokai.dark.css"><link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Kha&#39;s - Journeys and times of me"><link rel="alternate" href="/feed/feed.json" type="application/json" title="Kha&#39;s - Journeys and times of me"><link rel="stylesheet" href="/css/index.css"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({
        startOnLoad: true,
        theme: "forest",
      });</script></head><body><div class="topnav"><div class="topnav-content"><a href="/" style="vertical-align: middle"><img src="/img/home.svg" alt="home icon" align="middle" height="18" width="18"> <span>Kha</span> </a><a href="/research">Research</a> <a href="/blog">Blog</a><div class="topnav-right"><a href="https://github.com/lotusirous" target="_blank" rel="noreferrer" title="Github"><img alt="Github" src="/img/social/github.svg" height="20" width="20"></a><a href="https://twitter.com/__ngtrongkha" target="_blank" rel="noreferrer" title="Twitter"><img alt="Twitter" src="/img/social/twitter.svg" height="20" width="20"></a></div></div></div><div id="content"><div id="main"><main><div class="article"><div class="when"><time datetime="Oct 13, 2023">Oct 13, 2023</time></div><h1 class="post-title">Testing http client in Go</h1><h2>Http client in go</h2><pre class="language-go"><code class="language-go"><span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  httpClient <span class="token operator">*</span>http<span class="token punctuation">.</span>Client
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Send</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// do some stuff</span>
  <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span></code></pre><p>In the caller</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span><span class="token punctuation">(</span>s Service<span class="token punctuation">)</span> <span class="token function">Login</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// do some sutff</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>Client<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password <span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>
  <span class="token comment">// do more stuffs</span>
<span class="token punctuation">}</span></code></pre><h2>Define an interface for Client</h2><pre class="language-go"><code class="language-go"><span class="token comment">// Sends</span>
<span class="token keyword">type</span> Sender <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token function">Send</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span></code></pre><p>IN the service</p><pre class="language-go"><code class="language-go"><span class="token keyword">type</span> Service <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Client Sender
<span class="token punctuation">}</span></code></pre><p>Now, we can do the test</p><h2>Mock the http with <code>RoundTripper</code></h2><pre class="language-go"><code class="language-go"><span class="token keyword">type</span> client <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  httpClient <span class="token operator">*</span>http<span class="token punctuation">.</span>Client
<span class="token punctuation">}</span></code></pre><p>In the test file</p><pre class="language-go"><code class="language-go"><span class="token keyword">type</span> client <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  httpClient <span class="token operator">*</span>http<span class="token punctuation">.</span>Client
<span class="token punctuation">}</span></code></pre><div class="direction"><div class="next">« <a href="/posts/semgrep-with-vim/">Using semgrep in vim</a></div><div class="previous"><a href="/posts/fuzzy-finding-your-bookmarks/">Fuzzy Finding Your Bookmarks</a> »</div></div></div></main></div></div><footer></footer></body></html>