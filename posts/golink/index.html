<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="theme-color" content="#680"><title>Golink - URL shorten service</title><meta name="description" content="Learn from pro golang code."><link rel="stylesheet" href="/css/prism-base16-monokai.dark.css"><link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Kha&#39;s - Journeys and times of me"><link rel="alternate" href="/feed/feed.json" type="application/json" title="Kha&#39;s - Journeys and times of me"><link rel="stylesheet" href="/css/index.css"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({
        startOnLoad: true,
        theme: "forest",
      });</script></head><body><div class="topnav"><div class="topnav-content"><a href="/" style="vertical-align: middle"><img src="/img/home.svg" alt="home icon" align="middle" height="18" width="18"> <span>Kha</span> </a><a href="/research">Research</a> <a href="/blog">Blog</a><div class="topnav-right"><a href="https://github.com/lotusirous" target="_blank" rel="noreferrer" title="Github"><img alt="Github" src="/img/social/github.svg" height="20" width="20"></a><a href="https://twitter.com/__ngtrongkha" target="_blank" rel="noreferrer" title="Twitter"><img alt="Twitter" src="/img/social/twitter.svg" height="20" width="20"></a><a href="https://unix.stackexchange.com/users/40333/lotusirous" target="_blank" rel="noreferrer" title="StackExchange"><img alt="StackExchange" class="keep-original" src="/img/social/Stack_Exchange_icon.svg" height="20" width="20"></a></div></div></div><div id="content"><div id="main"><main><div class="article"><h1 class="post-title">Golink - URL shorten service</h1><div class="when"><time datetime="Thursday, December 1, 2022">Posted on Thursday, December 1, 2022</time></div><p>This note collects a few key things I have learned about Golink.</p><h2>Requirements</h2><ul><li>go links provide short, memorable links for the websites you and your team use most.</li><li>Count the number of clicks for a given link.</li><li>Save and load from/to the snapshot.</li></ul><p>The short link normalization:</p><ul><li>names must start with a letter or number</li><li>names may contain letters, numbers, hyphens, and periods</li><li>names are <strong>not</strong> case-sensitive (go/foo is the same as go/FOO)</li><li>hyphens are ignored when resolving links (go/meetingnotes is the same as go/meeting-notes)</li></ul><h2>Core function and data structure</h2><p>The main purpose of this project is to create a mapping between short links and long links, which is a one-to-one relationship. To achieve this, the project uses a <code>Link struct</code> that has two properties: <code>Short</code> and <code>Long</code> to store the mapping. Additionally, the <code>Link struct</code> also contains the time and owner properties.</p><pre class="language-go"><code class="language-go"><span class="token comment">// Link is the structure stored for each go short link.</span><br><span class="token keyword">type</span> Link <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    Short    <span class="token builtin">string</span> <span class="token comment">// the "foo" part of http://go/foo</span><br>    Long     <span class="token builtin">string</span><br>    Created  time<span class="token punctuation">.</span>Time<br>    LastEdit time<span class="token punctuation">.</span>Time <span class="token comment">// when the link was last edit</span><br>    Owner    <span class="token builtin">string</span>    <span class="token comment">// user@domain</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// ClickStats is the number of clicks a set of links have received in a given</span><br><span class="token comment">// time period. It is keyed by link short name, with values of total clicks.</span><br><span class="token keyword">type</span> ClickStats <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><br><br><br><span class="token keyword">var</span> stats <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    mu     sync<span class="token punctuation">.</span>Mutex<br>    clicks ClickStats<br>    dirty  ClickStats<br><span class="token punctuation">}</span></code></pre><p>The <code>stats</code> global variable uses a double buffering pattern to improve the performance of the service. This pattern involves minimizing the delay between input and output operations in the database management system by using a buffer.</p><p>The <code>stats</code> variable has two fields, <code>clicks</code> and <code>dirty</code>, which are both of the same type <code>ClickStats</code>, which is a map keyed by the short name of the link and with values representing the number of clicks. Whenever a short link is accessed, the <code>clicks</code> map is updated to increment the count for that link. Then, the <code>dirty</code> map is flushed to the database every 1 minute, so the changes are saved permanently.</p><p>The use of double buffering allows the service to handle a large number of requests without slowing down, as the database updates are performed in a separate background process. This way, the <code>stats</code> variable can keep an accurate count of the clicks for each short link without affecting the performance of the service.</p><h2>Database design</h2><p>Based on the <code>Link</code> and <code>Stats</code> structs described above, the design of the database tables can be as follows:</p><pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> Links <span class="token punctuation">(</span><br>    ID       <span class="token keyword">TEXT</span>    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>         <span class="token comment">-- normalized version of Short (foobar)</span><br>    Short    <span class="token keyword">TEXT</span>    <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token comment">-- user-provided Short name (Foo-Bar)</span><br>    Long     <span class="token keyword">TEXT</span>    <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">""</span><span class="token punctuation">,</span><br>    Created  <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span>strftime<span class="token punctuation">(</span><span class="token string">'%s'</span><span class="token punctuation">,</span> <span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- unix seconds</span><br>    LastEdit <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span>strftime<span class="token punctuation">(</span><span class="token string">'%s'</span><span class="token punctuation">,</span> <span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- unix seconds</span><br>    Owner    <span class="token keyword">TEXT</span>    <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">""</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> Stats <span class="token punctuation">(</span><br>    ID       <span class="token keyword">TEXT</span>    <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token comment">-- normalized short link to this id </span><br>    Created  <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span>strftime<span class="token punctuation">(</span><span class="token string">'%s'</span><span class="token punctuation">,</span> <span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- unix seconds</span><br>    Clicks   <span class="token keyword">INTEGER</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The Links table has 6 columns, with <code>ID</code> being the primary key and the other columns storing the different properties of the <code>Link</code> struct. The <code>Stats</code> table also has 3 columns, with <code>ID</code> referencing the <code>Links</code> table and the other columns storing the <code>Created</code> and <code>Clicks</code> properties of the <code>Stats</code> struct.</p><p>The <code>Links</code> table is used to store the short and long links and the metadata about their creation and last edit times and the owner of the link. The <code>Stats</code> table is used to store the number of clicks for each short link, with the <code>ID</code> column referencing the corresponding short link in the Links table and the <code>Clicks</code> column storing the total number of clicks.</p><p>There are a few things to consider:</p><ul><li>The <code>stats</code> table does not have a primary key ?</li></ul><p>=&gt; Since the <code>ClickStats</code> is using to read/insert to the table. It means the logic is implemented in the code. Because of <code>ClickStats</code> map type, there is no key duplication for the ID in this case.</p><ul><li>What if the database contains 2 rows but only one <code>key:value</code> in the map <code>stats</code> ?</li></ul><p>=&gt; It will not happen logically, there are only 2 events that related to the <code>stats</code> table; <code>LoadStats</code> is performed when the program in the initialized state. <code>SaveStats</code> is perform by flushing goroutine.</p><h2>Code patterns</h2><p>Here is some code patterns that you can improve your skill</p><h2>Double buffering pattern</h2><p>The global mutatble variable <code>stats</code> has an attribute <code>dirty</code>, which is a map. This map is initialized by loading from the database on boot.</p><p>The <code>dirty</code> is flushed to the database every 1 minute by a goroutine. The flushing's error is printed to stdout.</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">flushStatsLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">for</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">flushStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>            log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"flushing stats: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">flushStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>    stats<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">defer</span> stats<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">SaveStats</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> err<br>    <span class="token punctuation">}</span><br>    <span class="token comment">// reset the dirty after flush</span><br>    stats<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span>ClickStats<span class="token punctuation">)</span><br>    <span class="token keyword">return</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span></code></pre><h2>Init the template</h2><p>The web services init and embedded the template in the <code>init</code> function. This is convenient because all template is packed inside the binary.</p><pre class="language-go"><code class="language-go"><span class="token comment">//go:embed static tmpl/*.html</span><br><span class="token keyword">var</span> embeddedFS embed<span class="token punctuation">.</span>FS<br><br><span class="token keyword">var</span> <span class="token punctuation">(</span><br>    <span class="token comment">// homeTmpl is the template used by the http://go/ index page where you can</span><br>    <span class="token comment">// create or edit links.</span><br>    homeTmpl <span class="token operator">*</span>template<span class="token punctuation">.</span>Template<br><br>    <span class="token comment">// detailTmpl is the template used by the link detail page to view or edit links.</span><br>    detailTmpl <span class="token operator">*</span>template<span class="token punctuation">.</span>Template<br><span class="token punctuation">)</span><br><br><br><span class="token comment">// parse template </span><br><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    homeTmpl <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">ParseFS</span><span class="token punctuation">(</span>embeddedFS<span class="token punctuation">,</span> <span class="token string">"tmpl/base.html"</span><span class="token punctuation">,</span> <span class="token string">"tmpl/home.html"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    detailTmpl <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">ParseFS</span><span class="token punctuation">(</span>embeddedFS<span class="token punctuation">,</span> <span class="token string">"tmpl/base.html"</span><span class="token punctuation">,</span> <span class="token string">"tmpl/detail.html"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><h2>Convert <code>sql.ErrNoRows</code> to <code>fs.ErrNotExist</code></h2><p>Since the database layer and the logic layer are separate, it is possible to convert the <code>sql.ErrNoRows</code> error to <code>fs.ErrNotExist</code> in the database layer. This conversion makes the error more meaningful to the logic in the HTTP handler.</p><p>For example, in the <code>db.go</code> file of our application, we can convert the <code>sql.ErrNoRows</code> error to the <code>fs.ErrNotExist</code> error when querying the database for a record. This conversion makes it easier for the HTTP handler to handle the error, as it can simply check for the existence of the <code>fs.ErrNotExist</code> error instead of having to check for the specific <code>sql.ErrNoRows</code> error.</p><pre class="language-go"><code class="language-go">row <span class="token operator">:=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">QueryRow</span><span class="token punctuation">(</span><span class="token string">"SELECT Short, Long, Created, LastEdit, Owner FROM Links WHERE ID = ?1 LIMIT 1"</span><span class="token punctuation">,</span> <span class="token function">linkID</span><span class="token punctuation">(</span>short<span class="token punctuation">)</span><span class="token punctuation">)</span><br>err <span class="token operator">:=</span> row<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>link<span class="token punctuation">.</span>Short<span class="token punctuation">,</span> <span class="token operator">&amp;</span>link<span class="token punctuation">.</span>Long<span class="token punctuation">,</span> <span class="token operator">&amp;</span>created<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lastEdit<span class="token punctuation">,</span> <span class="token operator">&amp;</span>link<span class="token punctuation">.</span>Owner<span class="token punctuation">)</span><br><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> sql<span class="token punctuation">.</span>ErrNoRows<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        err <span class="token operator">=</span> fs<span class="token punctuation">.</span>ErrNotExist<br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<br><span class="token punctuation">}</span></code></pre><h2>Global variables</h2><p>This program uses 3 global variables. This keeps the program is manageable.</p><ul><li><code>db *sql.DB</code></li><li><code>stats</code></li><li><code>LastSnapshot</code></li></ul><h2>Naming</h2><p>The author approach to naming request data is to use the <code>data</code> suffix. For example, instead of using <code>visitRequest</code>, which is a long and somewhat ambiguous name, we could use <code>visitData</code> or <code>homeData</code>. This suffix makes it clear that the data is associated with a request, and it is a more concise and consistent name.</p><h2>The main handler <code>serveGo</code></h2><p>The main serve handler</p><pre class="language-go"><code class="language-go">http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> serveGo<span class="token punctuation">)</span></code></pre><p>This handler finds the long link for a given short link. The author handles the error <code>fs.ErrNotExist</code> in the handler</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">serveGo</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> r<span class="token punctuation">.</span>RequestURI <span class="token operator">==</span> <span class="token string">"/"</span> <span class="token punctuation">{</span><br>        <span class="token keyword">switch</span> r<span class="token punctuation">.</span>Method <span class="token punctuation">{</span><br>        <span class="token keyword">case</span> <span class="token string">"GET"</span><span class="token punctuation">:</span><br>            <span class="token function">serveHome</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><br>        <span class="token keyword">case</span> <span class="token string">"POST"</span><span class="token punctuation">:</span><br>            <span class="token function">serveSave</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">return</span><br>    <span class="token punctuation">}</span><br><br>    short<span class="token punctuation">,</span> remainder<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Cut</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">TrimPrefix</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>RequestURI<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><br>    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"short: "</span> <span class="token operator">+</span> short <span class="token operator">+</span> <span class="token string">" remainder: "</span> <span class="token operator">+</span> remainder<span class="token punctuation">)</span><br><br>    <span class="token comment">// redirect {name}+ links to /.detail/{name}</span><br>    <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>short<span class="token punctuation">,</span> <span class="token string">"+"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        http<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token string">"/.detail/"</span><span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">TrimSuffix</span><span class="token punctuation">(</span>short<span class="token punctuation">,</span> <span class="token string">"+"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusFound<span class="token punctuation">)</span><br>        <span class="token keyword">return</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// The main logic is here. the global `db` variable load the given short url.</span><br>    <span class="token comment">// and returns the long url.</span><br>    link<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>short<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> fs<span class="token punctuation">.</span>ErrNotExist<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">serveHome</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> short<span class="token punctuation">)</span><br>        <span class="token keyword">return</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"serving %q: %v"</span><span class="token punctuation">,</span> short<span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>        http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span><br>        <span class="token keyword">return</span><br>    <span class="token punctuation">}</span><br><br><br>    <span class="token comment">// Update the stats variable, since it has a map type.</span><br>    <span class="token comment">// The lock is using to avoid reace condition.</span><br>    stats<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> stats<span class="token punctuation">.</span>clicks <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        stats<span class="token punctuation">.</span>clicks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span>ClickStats<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    stats<span class="token punctuation">.</span>clicks<span class="token punctuation">[</span>link<span class="token punctuation">.</span>Short<span class="token punctuation">]</span><span class="token operator">++</span><br>    <span class="token keyword">if</span> stats<span class="token punctuation">.</span>dirty <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        stats<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span>ClickStats<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    stats<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span>link<span class="token punctuation">.</span>Short<span class="token punctuation">]</span><span class="token operator">++</span><br>    stats<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    target<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">expandLink</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span>Long<span class="token punctuation">,</span> expandEnv<span class="token punctuation">{</span>Now<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UTC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Path<span class="token punctuation">:</span> remainder<span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"expanding %q: %v"</span><span class="token punctuation">,</span> link<span class="token punctuation">.</span>Long<span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>        http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span><br>        <span class="token keyword">return</span><br>    <span class="token punctuation">}</span><br>    http<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> target<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusFound<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><h3>Wrap the <code>main</code> function calls the <code>Run() error</code>.</h3><p>If you write all initialize functions in the <code>main</code>. You have to write the <code>log.Fatal</code> message for every returned error. The main function is only report one, and the error will return from the <code>Run() error</code> function.</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> err <span class="token operator">:=</span> golink<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>In the <code>golink</code> packages.</p><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>    err <span class="token operator">:=</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> err<br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><div class="direction"><div class="next">« <a href="/posts/byte-order-in-go/">How to Detect Byte Order in Go</a></div><div class="previous"><a href="/posts/function-snippet-for-go/">Generate return values in Neovim for Go.</a> »</div></div></div></main></div></div><footer></footer></body></html>