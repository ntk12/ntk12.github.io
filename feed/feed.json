{
  "version": "https://jsonfeed.org/version/1",
  "title": "Kha&#39;s - Journeys and times of me",
  "home_page_url": "https://lotusirous.github.io/",
  "feed_url": "https://lotusirous.github.io/feed/feed.json",
  "description": "This place is a note for myself",
  "author": {
    "name": "Your Name Here",
    "url": "https://lotusirous.github.io/about-me/"
  },
  "items": [{
      "id": "https://lotusirous.github.io/posts/mid-stack-inliner/",
      "url": "https://lotusirous.github.io/posts/mid-stack-inliner/",
      "title": "",
      "content_html": "",
      "date_published": "2023-05-03T03:54:02Z"
    },{
      "id": "https://lotusirous.github.io/posts/sparse-data-structure/",
      "url": "https://lotusirous.github.io/posts/sparse-data-structure/",
      "title": "An efficient representation of sparse set",
      "content_html": "<p>Sets are the fundamental structure of programming. Using the sets depends on the\nproblem kind. I found this sparse set representation from the golang codebase.\nThis is one of the gem that worth for study.</p>\n<p>The sparse implementation offer a constant time to clear-set, add-member, and\ndelete-member.</p>\n<pre class=\"language-go\"><code class=\"language-go\">dense <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">{</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">}</span></code></pre>\n",
      "date_published": "2023-04-18T00:00:00Z"
    },{
      "id": "https://lotusirous.github.io/posts/zP-in-vim/",
      "url": "https://lotusirous.github.io/posts/zP-in-vim/",
      "title": "`zy` and `zp` in recent vim ",
      "content_html": "<p>This task is very common for manipulating the column</p>\n<p>Set 1:</p>\n<pre><code>|of lines.\n|different lengths.\n|now together.\n</code></pre>\n<p>Set 2:</p>\n<pre><code>My blocks\nAll have\nBut are\n</code></pre>\n<p>Result:</p>\n<pre><code>My blocks|of lines.\nAll have|different lengths.\nBut are|now together.\n</code></pre>\n<p>The steps as follows:</p>\n<ul>\n<li>Use <code>c-v</code> and <code>D</code> to copy the line in column from Set 2.</li>\n<li>Go the the first line of Set 1 and paste with <code>zP</code></li>\n</ul>\n",
      "date_published": "2023-02-08T00:00:00Z"
    },{
      "id": "https://lotusirous.github.io/posts/zero-allocated-byte-to-string/",
      "url": "https://lotusirous.github.io/posts/zero-allocated-byte-to-string/",
      "title": "Zero allocated byte to string conversion in Go",
      "content_html": "<p>Go has a built-in function for converting a slice of bytes to a string, but it\ninvolves allocating a new string. If you want to avoid this allocation, you can\nuse a trick that involves the <code>unsafe</code> package.</p>\n<p>I recently learned about this trick from a\n<a href=\"https://twitter.com/juliusvolz/status/1603052194944913409?s=20&amp;t=33gnYg4Lbl6dRMzZFu8X0w\">tweet</a>\nin\n<a href=\"https://github.com/prometheus/prometheus/blob/e1b708200853371517480176da0a03437b3bb2c2/tsdb/index/index.go#L1906\">prometheus repository</a>\nand followed\n<a href=\"https://github.com/golang/go/issues/25484\">the discussion on Github</a>. It turns\nout that this trick was originally used in the\n<a href=\"https://go.dev/src/strings/builder.go#L45\"><code>strings</code> package</a>, and it works by\nusing type coercion to convert the memory address of the slice to a string\npointer, and then dereferencing that pointer to get the string value. Here is\nthe code:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">ByteSlice2String</span><span class=\"token punctuation\">(</span>b <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">if</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">return</span> <span class=\"token string\">\"\"</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token keyword\">return</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Pointer</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>Here's how it works:</p>\n<ol>\n<li><code>unsafe.Pointer(&amp;bs)</code> takes the memory address of the slice bs and converts\nit to an <code>unsafe.Pointer</code>. An <code>unsafe.Pointer</code> is a special type in the\n<code>unsafe</code> package that can hold the address of any type.</li>\n<li><code>(*string)(unsafe.Pointer(&amp;bs))</code> converts the <code>unsafe.Pointer</code> to a string\npointer by performing type coercion. This creates a new string pointer that\npoints to the same memory address as the slice <code>bs</code>.</li>\n<li><code>*(*string)(unsafe.Pointer(&amp;bs))</code> dereferences the string pointer to get the\nstring value that it points to.</li>\n</ol>\n<h2>Prove it</h2>\n<p>This experiment shows the benchmark between the <code>string(bs)</code> and our\n<code>ByteSlice2String</code> function</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">var</span> <span class=\"token punctuation\">(</span><br>    someBytes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span><span class=\"token string\">`hello`</span><span class=\"token punctuation\">)</span><br>    str       <span class=\"token builtin\">string</span><br><span class=\"token punctuation\">)</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">BenchmarkByte2String</span><span class=\"token punctuation\">(</span>b <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>B<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    b<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"BuiltIn\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>b <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>B<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> b<span class=\"token punctuation\">.</span>N<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>            str <span class=\"token operator\">=</span> <span class=\"token function\">BuiltIn</span><span class=\"token punctuation\">(</span>someBytes<span class=\"token punctuation\">)</span><br>        <span class=\"token punctuation\">}</span><br>        b<span class=\"token punctuation\">.</span><span class=\"token function\">ReportAllocs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br><br>    b<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Byte2Slice\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>b <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>B<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> b<span class=\"token punctuation\">.</span>N<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>            str <span class=\"token operator\">=</span> <span class=\"token function\">ByteSlice2String</span><span class=\"token punctuation\">(</span>someBytes<span class=\"token punctuation\">)</span><br>        <span class=\"token punctuation\">}</span><br>        b<span class=\"token punctuation\">.</span><span class=\"token function\">ReportAllocs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span><br></code></pre>\n<p>Benchmark result shows that the function <code>ByteSlice2String</code> has zero allocation\nmemory.</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">goos: darwin<br>goarch: amd64<br>pkg: github.com/ntk12/temp<br>cpu: Intel(R) Core(TM) i9-9880H CPU @ 2.30GHz<br>BenchmarkBuildString<br>BenchmarkBuildString/BuiltIn<br>BenchmarkBuildString/BuiltIn-16          75249337         15.88 ns/op        5 B/op        1 allocs/op<br>BenchmarkBuildString/Byte2Slice<br>BenchmarkBuildString/Byte2Slice-16       324706618          3.652 ns/op        0 B/op        0 allocs/op<br>PASS<br>ok   github.com/ntk12/temp 4.461s</code></pre>\n<h2>When this trick goes wrong</h2>\n<p>Using the <code>unsafe</code> package and type coercion to convert a slice of bytes to a\nstring can lead to unpredictable behavior and can compromise the safety\nguarantees provided by Go. It may also produce incorrect results if the slice of\nbytes does not have the correct memory layout or encoding</p>\n<h2>The new way in go 1.20</h2>\n<p>Go 1.20 adds <a href=\"https://github.com/golang/go/issues/53003\"><code>SliceData</code>, <code>String</code>, and <code>StringData</code></a> which supports our cases in <a href=\"https://go-review.googlesource.com/c/go/+/427095\">the CL</a>. You can use the new function as follows:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">ByteSlice2String</span><span class=\"token punctuation\">(</span>b <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">if</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">return</span> <span class=\"token string\">\"\"</span><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token keyword\">return</span> unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">String2ByteSlice</span><span class=\"token punctuation\">(</span>s <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">return</span> unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Slice</span><span class=\"token punctuation\">(</span>unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">StringData</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n",
      "date_published": "2022-12-20T00:00:00Z"
    },{
      "id": "https://lotusirous.github.io/posts/byte-order-in-go/",
      "url": "https://lotusirous.github.io/posts/byte-order-in-go/",
      "title": "How to Detect Byte Order in Go",
      "content_html": "<p>The <a href=\"https://github.com/josharian/native\">native package</a> contains a method for\ndetecting byte order in Go. While this can sometimes lead to program portability\nissues, understanding how the package works can greatly improve the developer\nexperience.</p>\n<p>Byte order, also known as endianness, refers to the way in which a computer\nstores the individual bytes of a multi-byte data type in its memory.\nLittle-endian systems store the least significant byte at the lowest memory\naddress, while big-endian systems store the most significant byte at the lowest\nmemory address</p>\n<p>To detect the byte order of a system when working at a low level, you can use\nthe following snippet:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">var</span> Endian binary<span class=\"token punctuation\">.</span>ByteOrder<br><br><span class=\"token keyword\">var</span> IsBigEndian <span class=\"token builtin\">bool</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\tb <span class=\"token operator\">:=</span> <span class=\"token function\">uint16</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xff</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// one byte</span><br>\t<span class=\"token keyword\">if</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Pointer</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span><br>\t\tEndian <span class=\"token operator\">=</span> binary<span class=\"token punctuation\">.</span>BigEndian<br>\t\tIsBigEndian <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><br>\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>\t\tEndian <span class=\"token operator\">=</span> binary<span class=\"token punctuation\">.</span>LittleEndian<br>\t\tIsBigEndian <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><br>\t<span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>In this particular case, the <code>0xff</code> value is being used as a sentinel value to\ndetect the byte order of the system. The <code>0xff</code> value is chosen because it\nconsists of all 1 bits, which means that the most significant bit of the value\nwill be set to 1.</p>\n<p>In a big-endian system, the most significant byte (which in this case would be\n<code>0xff</code>) would be stored at the lowest memory address. Therefore, if the byte\npointed to by the <code>unsafe.Pointer</code> function is equal to 0, it means that the\nsystem is using a big-endian byte order because the <code>0xff</code> value has been\n&quot;truncated&quot; to just <code>0x00</code> due to the fact that the system is only storing the\nleast significant byte at the lowest memory address.</p>\n",
      "date_published": "2022-12-13T00:00:00Z"
    },{
      "id": "https://lotusirous.github.io/posts/golink/",
      "url": "https://lotusirous.github.io/posts/golink/",
      "title": "Golink - URL shorten service",
      "content_html": "<p>This note collects a few key things I have learned about Golink.</p>\n<h2>Requirements</h2>\n<ul>\n<li>go links provide short, memorable links for the websites you and your team use\nmost.</li>\n<li>Count the number of clicks for a given link.</li>\n<li>Save and load from/to the snapshot.</li>\n</ul>\n<p>The short link normalization:</p>\n<ul>\n<li>names must start with a letter or number</li>\n<li>names may contain letters, numbers, hyphens, and periods</li>\n<li>names are <strong>not</strong> case-sensitive (go/foo is the same as go/FOO)</li>\n<li>hyphens are ignored when resolving links (go/meetingnotes is the same as\ngo/meeting-notes)</li>\n</ul>\n<h2>Core function and data structure</h2>\n<p>The main purpose of this project is to create a mapping between short links and\nlong links, which is a one-to-one relationship. To achieve this, the project\nuses a <code>Link struct</code> that has two properties: <code>Short</code> and <code>Long</code> to store the\nmapping. Additionally, the <code>Link struct</code> also contains the time and owner\nproperties.</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// Link is the structure stored for each go short link.</span><br><span class=\"token keyword\">type</span> Link <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span><br>    Short    <span class=\"token builtin\">string</span> <span class=\"token comment\">// the \"foo\" part of http://go/foo</span><br>    Long     <span class=\"token builtin\">string</span><br>    Created  time<span class=\"token punctuation\">.</span>Time<br>    LastEdit time<span class=\"token punctuation\">.</span>Time <span class=\"token comment\">// when the link was last edit</span><br>    Owner    <span class=\"token builtin\">string</span>    <span class=\"token comment\">// user@domain</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token comment\">// ClickStats is the number of clicks a set of links have received in a given</span><br><span class=\"token comment\">// time period. It is keyed by link short name, with values of total clicks.</span><br><span class=\"token keyword\">type</span> ClickStats <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><br><br><br><span class=\"token keyword\">var</span> stats <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span><br>    mu     sync<span class=\"token punctuation\">.</span>Mutex<br>    clicks ClickStats<br>    dirty  ClickStats<br><span class=\"token punctuation\">}</span></code></pre>\n<p>The <code>stats</code> global variable uses a double buffering pattern to improve the\nperformance of the service. This pattern involves minimizing the delay between\ninput and output operations in the database management system by using a buffer.</p>\n<p>The <code>stats</code> variable has two fields, <code>clicks</code> and <code>dirty</code>, which are both of the\nsame type <code>ClickStats</code>, which is a map keyed by the short name of the link and\nwith values representing the number of clicks. Whenever a short link is\naccessed, the <code>clicks</code> map is updated to increment the count for that link.\nThen, the <code>dirty</code> map is flushed to the database every 1 minute, so the changes\nare saved permanently.</p>\n<p>The use of double buffering allows the service to handle a large number of\nrequests without slowing down, as the database updates are performed in a\nseparate background process. This way, the <code>stats</code> variable can keep an accurate\ncount of the clicks for each short link without affecting the performance of the\nservice.</p>\n<h2>Database design</h2>\n<p>Based on the <code>Link</code> and <code>Stats</code> structs described above, the design of the\ndatabase tables can be as follows:</p>\n<pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> Links <span class=\"token punctuation\">(</span><br>    ID       <span class=\"token keyword\">TEXT</span>    <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span>         <span class=\"token comment\">-- normalized version of Short (foobar)</span><br>    Short    <span class=\"token keyword\">TEXT</span>    <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">-- user-provided Short name (Foo-Bar)</span><br>    Long     <span class=\"token keyword\">TEXT</span>    <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span><br>    Created  <span class=\"token keyword\">INTEGER</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token punctuation\">(</span>strftime<span class=\"token punctuation\">(</span><span class=\"token string\">'%s'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'now'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">-- unix seconds</span><br>    LastEdit <span class=\"token keyword\">INTEGER</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token punctuation\">(</span>strftime<span class=\"token punctuation\">(</span><span class=\"token string\">'%s'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'now'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">-- unix seconds</span><br>    Owner    <span class=\"token keyword\">TEXT</span>    <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">\"\"</span><br><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> Stats <span class=\"token punctuation\">(</span><br>    ID       <span class=\"token keyword\">TEXT</span>    <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">-- normalized short link to this id </span><br>    Created  <span class=\"token keyword\">INTEGER</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token punctuation\">(</span>strftime<span class=\"token punctuation\">(</span><span class=\"token string\">'%s'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'now'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">-- unix seconds</span><br>    Clicks   <span class=\"token keyword\">INTEGER</span><br><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>The Links table has 6 columns, with <code>ID</code> being the primary key and the other\ncolumns storing the different properties of the <code>Link</code> struct. The <code>Stats</code> table\nalso has 3 columns, with <code>ID</code> referencing the <code>Links</code> table and the other\ncolumns storing the <code>Created</code> and <code>Clicks</code> properties of the <code>Stats</code> struct.</p>\n<p>The <code>Links</code> table is used to store the short and long links and the metadata\nabout their creation and last edit times and the owner of the link. The <code>Stats</code>\ntable is used to store the number of clicks for each short link, with the <code>ID</code>\ncolumn referencing the corresponding short link in the Links table and the\n<code>Clicks</code> column storing the total number of clicks.</p>\n<p>There are a few things to consider:</p>\n<ul>\n<li>The <code>stats</code> table does not have a primary key ?</li>\n</ul>\n<p>=&gt; Since the <code>ClickStats</code> is using to read/insert to the table. It means the\nlogic is implemented in the code. Because of <code>ClickStats</code> map type, there is no\nkey duplication for the ID in this case.</p>\n<ul>\n<li>What if the database contains 2 rows but only one <code>key:value</code> in the map\n<code>stats</code> ?</li>\n</ul>\n<p>=&gt; It will not happen logically, there are only 2 events that related to the\n<code>stats</code> table; <code>LoadStats</code> is performed when the program in the initialized\nstate. <code>SaveStats</code> is perform by flushing goroutine.</p>\n<h2>Code patterns</h2>\n<p>Here is some code patterns that you can improve your skill</p>\n<h2>Double buffering pattern</h2>\n<p>The global mutatble variable <code>stats</code> has an attribute <code>dirty</code>, which is a map.\nThis map is initialized by loading from the database on boot.</p>\n<p>The <code>dirty</code> is flushed to the database every 1 minute by a goroutine. The\nflushing's error is printed to stdout.</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">flushStatsLoop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> <span class=\"token function\">flushStats</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>            log<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"flushing stats: %v\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><br>        <span class=\"token punctuation\">}</span><br>        time<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>Minute<span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">flushStats</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span><br>    stats<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">defer</span> stats<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><br>    <span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">SaveStats</span><span class=\"token punctuation\">(</span>stats<span class=\"token punctuation\">.</span>dirty<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">return</span> err<br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token comment\">// reset the dirty after flush</span><br>    stats<span class=\"token punctuation\">.</span>dirty <span class=\"token operator\">=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span>ClickStats<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h2>Init the template</h2>\n<p>The web services init and embedded the template in the <code>init</code> function. This is\nconvenient because all template is packed inside the binary.</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">//go:embed static tmpl/*.html</span><br><span class=\"token keyword\">var</span> embeddedFS embed<span class=\"token punctuation\">.</span>FS<br><br><span class=\"token keyword\">var</span> <span class=\"token punctuation\">(</span><br>    <span class=\"token comment\">// homeTmpl is the template used by the http://go/ index page where you can</span><br>    <span class=\"token comment\">// create or edit links.</span><br>    homeTmpl <span class=\"token operator\">*</span>template<span class=\"token punctuation\">.</span>Template<br><br>    <span class=\"token comment\">// detailTmpl is the template used by the link detail page to view or edit links.</span><br>    detailTmpl <span class=\"token operator\">*</span>template<span class=\"token punctuation\">.</span>Template<br><span class=\"token punctuation\">)</span><br><br><br><span class=\"token comment\">// parse template </span><br><span class=\"token keyword\">func</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    homeTmpl <span class=\"token operator\">=</span> template<span class=\"token punctuation\">.</span><span class=\"token function\">Must</span><span class=\"token punctuation\">(</span>template<span class=\"token punctuation\">.</span><span class=\"token function\">ParseFS</span><span class=\"token punctuation\">(</span>embeddedFS<span class=\"token punctuation\">,</span> <span class=\"token string\">\"tmpl/base.html\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"tmpl/home.html\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br>    detailTmpl <span class=\"token operator\">=</span> template<span class=\"token punctuation\">.</span><span class=\"token function\">Must</span><span class=\"token punctuation\">(</span>template<span class=\"token punctuation\">.</span><span class=\"token function\">ParseFS</span><span class=\"token punctuation\">(</span>embeddedFS<span class=\"token punctuation\">,</span> <span class=\"token string\">\"tmpl/base.html\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"tmpl/detail.html\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h2>Convert <code>sql.ErrNoRows</code> to <code>fs.ErrNotExist</code></h2>\n<p>Since the database layer and the logic layer are separate, it is possible to\nconvert the <code>sql.ErrNoRows</code> error to <code>fs.ErrNotExist</code> in the database layer.\nThis conversion makes the error more meaningful to the logic in the HTTP\nhandler.</p>\n<p>For example, in the <code>db.go</code> file of our application, we can convert the\n<code>sql.ErrNoRows</code> error to the <code>fs.ErrNotExist</code> error when querying the database\nfor a record. This conversion makes it easier for the HTTP handler to handle the\nerror, as it can simply check for the existence of the <code>fs.ErrNotExist</code> error\ninstead of having to check for the specific <code>sql.ErrNoRows</code> error.</p>\n<pre class=\"language-go\"><code class=\"language-go\">row <span class=\"token operator\">:=</span> s<span class=\"token punctuation\">.</span>db<span class=\"token punctuation\">.</span><span class=\"token function\">QueryRow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT Short, Long, Created, LastEdit, Owner FROM Links WHERE ID = ?1 LIMIT 1\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">linkID</span><span class=\"token punctuation\">(</span>short<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br>err <span class=\"token operator\">:=</span> row<span class=\"token punctuation\">.</span><span class=\"token function\">Scan</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>link<span class=\"token punctuation\">.</span>Short<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>link<span class=\"token punctuation\">.</span>Long<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>created<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>lastEdit<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>link<span class=\"token punctuation\">.</span>Owner<span class=\"token punctuation\">)</span><br><span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">if</span> errors<span class=\"token punctuation\">.</span><span class=\"token function\">Is</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> sql<span class=\"token punctuation\">.</span>ErrNoRows<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        err <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span>ErrNotExist<br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err<br><span class=\"token punctuation\">}</span></code></pre>\n<h2>Global variables</h2>\n<p>This program uses 3 global variables. This keeps the program is manageable.</p>\n<ul>\n<li><code>db *sql.DB</code></li>\n<li><code>stats</code></li>\n<li><code>LastSnapshot</code></li>\n</ul>\n<h2>Naming</h2>\n<p>The author approach to naming request data is to use the <code>data</code> suffix. For\nexample, instead of using <code>visitRequest</code>, which is a long and somewhat ambiguous\nname, we could use <code>visitData</code> or <code>homeData</code>. This suffix makes it clear that\nthe data is associated with a request, and it is a more concise and consistent\nname.</p>\n<h2>The main handler <code>serveGo</code></h2>\n<p>The main serve handler</p>\n<pre class=\"language-go\"><code class=\"language-go\">http<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> serveGo<span class=\"token punctuation\">)</span></code></pre>\n<p>This handler finds the long link for a given short link. The author handles the\nerror <code>fs.ErrNotExist</code> in the handler</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">serveGo</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">if</span> r<span class=\"token punctuation\">.</span>RequestURI <span class=\"token operator\">==</span> <span class=\"token string\">\"/\"</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">switch</span> r<span class=\"token punctuation\">.</span>Method <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">case</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">:</span><br>            <span class=\"token function\">serveHome</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><br>        <span class=\"token keyword\">case</span> <span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">:</span><br>            <span class=\"token function\">serveSave</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">)</span><br>        <span class=\"token punctuation\">}</span><br>        <span class=\"token keyword\">return</span><br>    <span class=\"token punctuation\">}</span><br><br>    short<span class=\"token punctuation\">,</span> remainder<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> strings<span class=\"token punctuation\">.</span><span class=\"token function\">Cut</span><span class=\"token punctuation\">(</span>strings<span class=\"token punctuation\">.</span><span class=\"token function\">TrimPrefix</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>RequestURI<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><br>    log<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"short: \"</span> <span class=\"token operator\">+</span> short <span class=\"token operator\">+</span> <span class=\"token string\">\" remainder: \"</span> <span class=\"token operator\">+</span> remainder<span class=\"token punctuation\">)</span><br><br>    <span class=\"token comment\">// redirect {name}+ links to /.detail/{name}</span><br>    <span class=\"token keyword\">if</span> strings<span class=\"token punctuation\">.</span><span class=\"token function\">HasSuffix</span><span class=\"token punctuation\">(</span>short<span class=\"token punctuation\">,</span> <span class=\"token string\">\"+\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        http<span class=\"token punctuation\">.</span><span class=\"token function\">Redirect</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/.detail/\"</span><span class=\"token operator\">+</span>strings<span class=\"token punctuation\">.</span><span class=\"token function\">TrimSuffix</span><span class=\"token punctuation\">(</span>short<span class=\"token punctuation\">,</span> <span class=\"token string\">\"+\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> http<span class=\"token punctuation\">.</span>StatusFound<span class=\"token punctuation\">)</span><br>        <span class=\"token keyword\">return</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token comment\">// The main logic is here. the global `db` variable load the given short url.</span><br>    <span class=\"token comment\">// and returns the long url.</span><br>    link<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">Load</span><span class=\"token punctuation\">(</span>short<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> errors<span class=\"token punctuation\">.</span><span class=\"token function\">Is</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> fs<span class=\"token punctuation\">.</span>ErrNotExist<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token function\">serveHome</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> short<span class=\"token punctuation\">)</span><br>        <span class=\"token keyword\">return</span><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>        log<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"serving %q: %v\"</span><span class=\"token punctuation\">,</span> short<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><br>        http<span class=\"token punctuation\">.</span><span class=\"token function\">Error</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">.</span><span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> http<span class=\"token punctuation\">.</span>StatusInternalServerError<span class=\"token punctuation\">)</span><br>        <span class=\"token keyword\">return</span><br>    <span class=\"token punctuation\">}</span><br><br><br>    <span class=\"token comment\">// Update the stats variable, since it has a map type.</span><br>    <span class=\"token comment\">// The lock is using to avoid reace condition.</span><br>    stats<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> stats<span class=\"token punctuation\">.</span>clicks <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>        stats<span class=\"token punctuation\">.</span>clicks <span class=\"token operator\">=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span>ClickStats<span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span><br>    stats<span class=\"token punctuation\">.</span>clicks<span class=\"token punctuation\">[</span>link<span class=\"token punctuation\">.</span>Short<span class=\"token punctuation\">]</span><span class=\"token operator\">++</span><br>    <span class=\"token keyword\">if</span> stats<span class=\"token punctuation\">.</span>dirty <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>        stats<span class=\"token punctuation\">.</span>dirty <span class=\"token operator\">=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span>ClickStats<span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span><br>    stats<span class=\"token punctuation\">.</span>dirty<span class=\"token punctuation\">[</span>link<span class=\"token punctuation\">.</span>Short<span class=\"token punctuation\">]</span><span class=\"token operator\">++</span><br>    stats<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><br>    target<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> <span class=\"token function\">expandLink</span><span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">.</span>Long<span class=\"token punctuation\">,</span> expandEnv<span class=\"token punctuation\">{</span>Now<span class=\"token punctuation\">:</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">UTC</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Path<span class=\"token punctuation\">:</span> remainder<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>        log<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"expanding %q: %v\"</span><span class=\"token punctuation\">,</span> link<span class=\"token punctuation\">.</span>Long<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><br>        http<span class=\"token punctuation\">.</span><span class=\"token function\">Error</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">.</span><span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> http<span class=\"token punctuation\">.</span>StatusInternalServerError<span class=\"token punctuation\">)</span><br>        <span class=\"token keyword\">return</span><br>    <span class=\"token punctuation\">}</span><br>    http<span class=\"token punctuation\">.</span><span class=\"token function\">Redirect</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">,</span> http<span class=\"token punctuation\">.</span>StatusFound<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h3>Wrap the <code>main</code> function calls the <code>Run() error</code>.</h3>\n<p>If you write all initialize functions in the <code>main</code>. You have to write the\n<code>log.Fatal</code> message for every returned error. The main function is only report\none, and the error will return from the <code>Run() error</code> function.</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> golink<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>        log<span class=\"token punctuation\">.</span><span class=\"token function\">Fatal</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>In the <code>golink</code> packages.</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span><br>    err <span class=\"token operator\">:=</span> <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">return</span> err<br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n",
      "date_published": "2022-12-01T00:00:00Z"
    },{
      "id": "https://lotusirous.github.io/posts/function-snippet-for-go/",
      "url": "https://lotusirous.github.io/posts/function-snippet-for-go/",
      "title": "Generate return values in Neovim for Go.",
      "content_html": "<p>I'm a big fan of error handling in Go because of its clarity and simplicity.\nHowever, I sometimes find it tedious to have to type <code>if err != nil</code> for every\nerror handling error. That's why I'm excited to share with you a new technique\nthat I've discovered for reducing the number of keystrokes needed for error\nhandling in Go. By combining the\n<a href=\"https://github.com/nvim-treesitter/nvim-treesitter\">nvim-treesitter</a> and\n<a href=\"https://github.com/L3MON4D3/LuaSnip\">LuaSnip</a> tools, you can easily generate\nthe return values for your error handling errors, saving you time and making\nyour code more efficient.</p>\n<p>In this post, I'll explain how to set up and use this technique, so that you can\nenjoy the benefits of error handling in Go without all the tedious typing.</p>\n<h2>Tree-sitter and LuaSnip</h2>\n<p><strong>Tree-sitter</strong> is a parser generator tool that can build parsers for\nprogramming languages. It uses incremental parsing to quickly and accurately\nparse source code as it is being edited. In Go, tree-sitter can generate an\nabstract syntax tree (AST) for a Go source file, which can be used for code\nanalysis, code completion, or code generation.</p>\n<p><strong>LuaSnip</strong> is a neovim plugin that allows users to define and manage code\nsnippets using Lua. It can save time and improve productivity by allowing users\nto insert code snippets quickly and easily. It also offers features like\ncontext-aware expansion, completion, and arguments.</p>\n<h2>Generate the snippet</h2>\n<p>This code defines a tree-sitter query for Go source code that uses the <code>set_query</code> function from the <code>vim.treesitter</code> module. The query is stored in a variable called <code>LuaSnip_Result</code>, and it searches for three different types of declarations in Go source code: method declarations, function declarations, and function literals.</p>\n<p>For each of these declarations, the query stores the result in a variable called <code>@id</code>, which can be used later to reference the specific declaration that was found. The query uses the tree-sitter query language, which is a syntax for defining and running queries on abstract syntax trees (ASTs) generated by tree-sitter parsers.</p>\n<p>The second part of the code creates a code snippet called &quot;iferr&quot; that uses the results of the <code>LuaSnip_Result</code> query to automatically generate the return values for the function or method specified in the &quot;f&quot; input field. This can save you time and effort. When you type &quot;iferr&quot; the result will match the function and returned value from the method.</p>\n<pre class=\"language-lua\"><code class=\"language-lua\">vim<span class=\"token punctuation\">.</span>treesitter<span class=\"token punctuation\">.</span><span class=\"token function\">set_query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"go\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"LuaSnip_Result\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">[[<br>    (method_declaration result: (_) @id)<br>    (function_declaration result: (_) @id)<br>    (func_literal result: (_) @id)<br>]]</span><span class=\"token punctuation\">)</span><br><br><span class=\"token function\">s</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"iferr\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token function\">i</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"val\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br>    t <span class=\"token string\">\", \"</span><span class=\"token punctuation\">,</span><br>    <span class=\"token function\">i</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"err\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br>    t <span class=\"token string\">\" := \"</span><span class=\"token punctuation\">,</span><br>    <span class=\"token function\">i</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"f\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br>    <span class=\"token function\">t</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"if \"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>    <span class=\"token function\">same</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br>    <span class=\"token function\">t</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\" != nil {\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\\treturn \"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>    <span class=\"token function\">d</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> go_ret_vals<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br>    <span class=\"token function\">t</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"}\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>    <span class=\"token function\">i</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre>\n<p>Let's give it a try.</p>\n<pre><code>iferr&lt;c-k&gt;\n</code></pre>\n<h2>Conclusion</h2>\n<p>In conclusion, this post has shown you how to use tree-sitter and LuaSnip to\ncreate a code snippet for Go development that can automatically generate the\nreturn values for error handling errors. This technique can improve your\nworkflow and make your code more efficient and effective. By using this\napproach, you can reduce the amount of time and effort you spend on error\nhandling in Go.</p>\n",
      "date_published": "2022-05-28T00:00:00Z"
    },{
      "id": "https://lotusirous.github.io/posts/smart-contract-practices/",
      "url": "https://lotusirous.github.io/posts/smart-contract-practices/",
      "title": "Smart contract hacking resources",
      "content_html": "<p>I'm using the following resources to build up the background to learn/hack the smart contract</p>\n<h2>Background</h2>\n<p>Books:</p>\n<ul>\n<li>Mastering Ethereum: Building Smart Contracts and DApps</li>\n<li>Building Ethereum DApps: Decentralized Applications on the Ethereum Blockchain</li>\n</ul>\n<p>Tutorials:</p>\n<ul>\n<li><a href=\"https://ethereum.org/en/developers/learning-tools/\">All tutorials and learning-by-coding from ETH</a></li>\n<li>Learn Solidity</li>\n<li><a href=\"https://cryptozombies.io/\">CryptoZombies</a></li>\n<li><a href=\"https://solidity-by-example.org/\">Solidity by Example</a></li>\n<li>Solidity Docs</li>\n<li>Learn how to use <a href=\"https://hardhat.org/\">HardHat</a></li>\n<li>Familiarize yourself with widely used contracts (EIP 20)</li>\n</ul>\n<h2>Challenges</h2>\n<ul>\n<li>Read writeups &amp; postmortems</li>\n<li>Do some CTF's</li>\n</ul>\n<h2>Resources</h2>\n<ul>\n<li><a href=\"https://youtu.be/M576WGiDBdQ\">Solidity, Blockchain, and Smart Contract Course – Beginner to Expert Python Tutorial</a></li>\n<li><a href=\"https://blog.sigmaprime.io/-solidity-security.html\">Solidity Security: Comprehensive list of known attack vectors and common anti-patterns</a></li>\n<li><a href=\"https://swcregistry.io/\">Smart Contract Weakness Classification and Test Cases</a></li>\n<li><a href=\"https://consensys.github.io/smart-contract-best-practices/\">Ethereum Smart Contract Security Best Practices</a></li>\n</ul>\n",
      "date_published": "2021-10-17T00:00:00Z"
    },{
      "id": "https://lotusirous.github.io/posts/flare-on-challenge-1/",
      "url": "https://lotusirous.github.io/posts/flare-on-challenge-1/",
      "title": "[Flare on 2020] Level 1",
      "content_html": "<p>This challenge is a python that have compiled to windows program. The organizer\nalso gives us a source code of this program. Let's dive into the code by static\nanalysis. We have the following functions</p>\n<pre class=\"language-txt\"><code class=\"language-txt\"> +buy_click : function<br> +cat_clicked : function<br> +decode_flag : function &lt;--<br> +game_screen : function<br> +main : function<br> +password_check : function &lt;--<br> +password_fail_screen : function<br> +password_screen : function<br> +victory_screen : function<br>▼ variables<br>    buying<br>    current_autoclickers<br>    current_coins</code></pre>\n<p>It looks like the program has several functions that may be of interest to us.\nIn particular, the <code>password_check</code> and <code>decode_flag</code> functions stand out as\npotentially important.</p>\n<p>To start, let's take a closer look at the <code>password_check</code> function. This\nfunction is likely responsible for verifying the user's password, so it will be\nimportant to understand how it works and what it does. We can examine the code\nline by line to see what it does and how it operates.</p>\n<p>Next, let's move on to the <code>decode_flag</code> function. This function is probably\nresponsible for decoding the flag that we need to find in order to solve the\nchallenge. By analyzing the code in this function, we can learn more about how\nthe flag is encoded and what we need to do to decode it.</p>\n<p><strong>The <code>password_check</code> function</strong></p>\n<p>Since the program requires user to enter a password with a protect screen, the\ndeveloper implements this feature by 2 functions:</p>\n<ul>\n<li><code>password_screen</code> shows the input text.</li>\n<li><code>password_check</code> checks the password as follows</li>\n</ul>\n<pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">def</span> <span class=\"token function\">password_check</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><br>    altered_key <span class=\"token operator\">=</span> <span class=\"token string\">\"hiptu\"</span><br>    key <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">chr</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">ord</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> altered_key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span> <span class=\"token builtin\">input</span> <span class=\"token operator\">==</span> key</code></pre>\n<p>The solution is trivial, they key is &quot;ghost&quot; by running the code in python\ninterpreter</p>\n<pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">chr</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">ord</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> <span class=\"token string\">\"hiptu\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre>\n<p><strong>The <code>decode_flag</code> function</strong></p>\n<p>I discovered that the <code>victory_screen</code> function calls the <code>decode_flag</code> function\nby using the &quot;find references&quot; feature from the Language Server Protocol (LSP).\nThe <code>game_screen</code> function calculates the token value using the following logic:</p>\n<pre class=\"language-py\"><code class=\"language-py\">target_amount <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">**</span> <span class=\"token number\">36</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">**</span> <span class=\"token number\">35</span><span class=\"token punctuation\">)</span><br><span class=\"token keyword\">if</span> current_coins <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>target_amount <span class=\"token operator\">-</span> <span class=\"token number\">2</span> <span class=\"token operator\">**</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><br>    <span class=\"token keyword\">while</span> current_coins <span class=\"token operator\">>=</span> <span class=\"token punctuation\">(</span>target_amount <span class=\"token operator\">+</span> <span class=\"token number\">2</span> <span class=\"token operator\">**</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><br>        current_coins <span class=\"token operator\">-=</span> <span class=\"token number\">2</span> <span class=\"token operator\">**</span> <span class=\"token number\">20</span><br>    victory_screen<span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>current_coins <span class=\"token operator\">/</span> <span class=\"token number\">10</span> <span class=\"token operator\">**</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span></code></pre>\n<p>In order to display the victory screen and see the flag, the <code>current_coins</code>\nvariable must have a value greater than <code>(target_amount - 2 ** 20)</code>. To achieve\nthis, we can use the following code:</p>\n<pre class=\"language-python\"><code class=\"language-python\">target_amount <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">**</span> <span class=\"token number\">36</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">**</span> <span class=\"token number\">35</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span>  <span class=\"token comment\"># +1 to jump inside the while loop.</span><br>current_coins <span class=\"token operator\">=</span> target_amount <span class=\"token operator\">-</span> <span class=\"token number\">2</span> <span class=\"token operator\">**</span> <span class=\"token number\">20</span><br><span class=\"token keyword\">while</span> current_coins <span class=\"token operator\">>=</span> <span class=\"token punctuation\">(</span>target_amount <span class=\"token operator\">+</span> <span class=\"token number\">2</span> <span class=\"token operator\">**</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><br>    current_coins <span class=\"token operator\">-=</span> <span class=\"token number\">2</span> <span class=\"token operator\">**</span> <span class=\"token number\">20</span><br>token <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>current_coins <span class=\"token operator\">/</span> <span class=\"token number\">10</span> <span class=\"token operator\">**</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span></code></pre>\n<p>With the <code>token</code> value calculated, we can now call the <code>decode_flag</code> function to\ndecode the flag and print it to the screen:</p>\n<pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>decode_flag<span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br>idle_with_kitty@flare<span class=\"token operator\">-</span>on<span class=\"token punctuation\">.</span>com</code></pre>\n",
      "date_published": "2020-10-17T00:00:00Z"
    }
  ]
}
